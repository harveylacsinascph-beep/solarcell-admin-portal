<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="../api-config.js"></script>
</head>

<body class="bg-gray-100 min-h-screen font-sans">

<div class="flex min-h-screen">

  <!-- SIDEBAR -->
  <aside class="w-64 bg-gradient-to-b from-slate-900 to-slate-800 text-white fixed left-0 top-0 h-screen z-40 flex flex-col">
    <div class="p-6 border-b border-slate-700">
      <h1 class="text-xl font-bold">SolarCell PH</h1>
      <p class="text-sm text-slate-400">Employee Portal</p>
    </div>

    <nav class="flex-1 px-4 mt-4 space-y-1">
      <a href="employee_dashboard.html" class="block px-4 py-2 rounded-lg hover:bg-slate-700">Dashboard</a>
      <a href="leave.html" class="block px-4 py-2 rounded-lg hover:bg-slate-700">Leave Request</a>
      <a href="attendance.html" class="block px-4 py-2 rounded-lg bg-indigo-600 font-semibold">Attendance</a>
      <a href="semaphore.html" class="block px-4 py-2 rounded-lg hover:bg-slate-700">Semaphore</a>
  
      <a href="profile.html" class="block px-4 py-2 rounded-lg hover:bg-slate-700">Profile</a>
    </nav>

    <div class="p-4 border-t border-slate-700">
      <p class="text-sm text-slate-400">Logged in as</p>
      <p id="employeeName" class="font-semibold">Employee</p>
      <button class="mt-4 text-red-400 hover:text-red-500">Logout</button>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="ml-64 w-full p-8">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-800">Attendance</h1>
      <p class="text-sm text-gray-500">Track your attendance records.</p>
    </div>

    <!-- FILTER CARD -->
    <section class="bg-white rounded-xl shadow p-6 mb-6">
      <div class="flex flex-col md:flex-row gap-4 mb-4">
        <div>
          <label class="block text-sm text-gray-600 mb-1">Date</label>
          <input id="dateFilter" type="date" class="border rounded px-3 py-2 text-sm w-full">
        </div>
      </div>
      <div class="text-xs text-gray-500">
        Leave date empty to show all records.
      </div>
    </section>

    <!-- TABLE CARD -->
    <section class="bg-white rounded-xl shadow p-6">
      <div class="overflow-x-auto">
        <table class="w-full text-sm border-collapse text-center">
          <thead>
            <tr class="bg-gray-100">
              <th class="border px-4 py-3 font-medium">Date</th>
              <th class="border px-4 py-3 font-medium">Time In</th>
              <th class="border px-4 py-3 font-medium">Time Out</th>
              <th class="border px-4 py-3 font-medium">Worked Hours</th>
            </tr>
          </thead>
          <tbody id="attendanceTable"></tbody>
        </table>
      </div>

      <!-- PAGINATION -->
      <div class="mt-4 flex justify-between items-center">
        <div class="text-sm text-gray-600" id="paginationInfo"></div>
        <div class="flex gap-1" id="paginationButtons"></div>
      </div>
    </section>

  </main>
</div>

<script>
  // Display logged in user name
  const user = JSON.parse(localStorage.getItem('user'));
  const employeeNameDiv = document.getElementById('employeeName');
  if (user && user.employee_name) {
    employeeNameDiv.textContent = user.employee_name;
  }

  // Logout functionality
  document.querySelector('button').addEventListener('click', () => {
    window.location.href = '../auth-login.html';
  });

  let attendanceData = [];
  let currentPage = 1;
  let entries = 10;

  async function loadAttendanceData() {
    if (!user || !user.employee_id) {
      const tbody = document.getElementById("attendanceTable");
      tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-red-500">User not logged in</td></tr>';
      return;
    }

    try {
      const response = await fetch(`${API_BASE_URL}/attendance/employee/${user.employee_id}`);
      if (!response.ok) {
        throw new Error('Failed to fetch attendance data');
      }
      attendanceData = await response.json();
      renderTable();
    } catch (error) {
      console.error('Error loading attendance data:', error);
      const tbody = document.getElementById("attendanceTable");
      tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-red-500">Error loading attendance data</td></tr>';
    }
  }

  function getFilteredData() {
    const date = document.getElementById("dateFilter").value;
    return attendanceData.filter(row => {
      const matchDate = !date || row.date === date;
      return matchDate;
    });
  }

  function formatWorkedHours(hours) {
    if (!hours) return '-';
    const numHours = parseFloat(hours);
    if (isNaN(numHours)) return '-';
    const wholeHours = Math.floor(numHours);
    const minutes = Math.round((numHours - wholeHours) * 60);
    return `${wholeHours}h ${minutes}m`;
  }

  function renderTable() {
    const filtered = getFilteredData();
    const totalPages = Math.ceil(filtered.length / entries);
    if (currentPage > totalPages) currentPage = totalPages || 1;

    const start = (currentPage - 1) * entries;
    const pagedData = filtered.slice(start, start + entries);

    const tbody = document.getElementById("attendanceTable");
    tbody.innerHTML = "";

    if (pagedData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">No attendance records found</td></tr>';
    } else {
      pagedData.forEach(row => {
        const timeOut = row.time_out || '-';
        const workedHours = formatWorkedHours(row.worked_hours);
        tbody.innerHTML += `
          <tr class="border-b hover:bg-gray-50">
            <td class="border px-4 py-3">${row.date}</td>
            <td class="border px-4 py-3">${row.time_in}</td>
            <td class="border px-4 py-3">${timeOut}</td>
            <td class="border px-4 py-3">${workedHours}</td>
          </tr>`;
      });
    }

    renderPagination(filtered.length);
  }

  function renderPagination(totalItems) {
    const totalPages = Math.ceil(totalItems / entries);
    const paginationButtons = document.getElementById("paginationButtons");
    const paginationInfo = document.getElementById("paginationInfo");

    paginationButtons.innerHTML = "";
    paginationInfo.textContent = `Showing ${Math.min((currentPage - 1) * entries + 1, totalItems)} to ${Math.min(currentPage * entries, totalItems)} of ${totalItems} entries`;

    const prevBtn = document.createElement("button");
    prevBtn.textContent = "‹";
    prevBtn.className = "px-2 py-1 rounded border hover:bg-gray-100 disabled:opacity-50";
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => { if (currentPage > 1) { currentPage--; renderTable(); } };
    paginationButtons.appendChild(prevBtn);

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      btn.className = currentPage === i
        ? "px-2 py-1 rounded bg-indigo-600 text-white border border-indigo-600"
        : "px-2 py-1 rounded border hover:bg-gray-100";
      btn.onclick = () => { currentPage = i; renderTable(); };
      paginationButtons.appendChild(btn);
    }

    const nextBtn = document.createElement("button");
    nextBtn.textContent = "›";
    nextBtn.className = "px-2 py-1 rounded border hover:bg-gray-100 disabled:opacity-50";
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => { if (currentPage < totalPages) { currentPage++; renderTable(); } };
    paginationButtons.appendChild(nextBtn);
  }

  document.getElementById("dateFilter").addEventListener("change", () => {
    currentPage = 1;
    renderTable();
  });

  // Load data on page load
  loadAttendanceData();
</script>

</body>
</html>
